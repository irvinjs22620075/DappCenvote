---
const CONTRACT_ID = "GC627W5PYYE5SXWAKC4LB72OYY3JMCP33N7KZ6EILCWAQNHIQDMB3O5W";
---

<div class="min-h-screen bg-gray-100 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header Section -->
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">CenVote Platform</h1>
            <p class="text-xl text-gray-600">Secure and Transparent Voting System</p>
        </div>

        <!-- Wallet Connection Section -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-semibold text-gray-800">Wallet Connection</h2>
                <button
                    id="connectWallet"
                    class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                >
                    Connect Freighter Wallet
                </button>
            </div>
            <p id="walletStatus" class="mt-4 text-gray-600">Wallet status: Not connected</p>
        </div>

        <!-- Active Votes Section -->
        <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
            <!-- Sample Vote Card -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-6">
                    <h3 class="text-xl font-semibold text-gray-900 mb-2">Community Proposal #1</h3>
                    <p class="text-gray-600 mb-4">Vote on the new community guidelines</p>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">Time remaining:</span>
                            <span class="text-sm font-medium text-primary">2 days</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-sm text-gray-500">Total votes:</span>
                            <span class="text-sm font-medium text-primary">156</span>
                        </div>
                    </div>
                    <div class="mt-6 space-y-2">
                        <button class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">
                            Vote Yes
                        </button>
                        <button class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-2 px-4 rounded-lg transition duration-300">
                            Vote No
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Create Survey Section -->
        <div class="mt-12 bg-white rounded-lg shadow-lg p-6" id="createSurveySection">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Crear Nueva Encuesta</h2>
            <form class="space-y-6" id="createSurveyForm">
                <div>
                    <label for="surveyName" class="block text-sm font-medium text-gray-700">Nombre de la Encuesta</label>
                    <input
                        type="text"
                        id="surveyName"
                        name="surveyName"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                        required
                    />
                </div>
                <div>
                    <label for="surveyDescription" class="block text-sm font-medium text-gray-700">Descripción</label>
                    <textarea
                        id="surveyDescription"
                        name="surveyDescription"
                        rows="4"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                        required
                    ></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="startDate" class="block text-sm font-medium text-gray-700">Fecha de Inicio</label>
                        <input
                            type="datetime-local"
                            id="startDate"
                            name="startDate"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                            required
                        />
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium text-gray-700">Fecha Final</label>
                        <input
                            type="datetime-local"
                            id="endDate"
                            name="endDate"
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                            required
                        />
                    </div>
                </div>
                <button
                    type="submit"
                    class="w-full bg-primary hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300"
                >
                    Crear Encuesta
                </button>
            </form>
        </div>

        <!-- Add/Edit Candidate Section -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6" id="candidateSection">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Gestión de Candidatos</h2>
            <form class="space-y-6" id="candidateForm">
                <input type="hidden" id="candidateId" name="candidateId" />
                <div>
                    <label for="candidateName" class="block text-sm font-medium text-gray-700">Nombre del Candidato</label>
                    <input
                        type="text"
                        id="candidateName"
                        name="candidateName"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                        required
                    />
                </div>
                <div>
                    <label for="candidateRfc" class="block text-sm font-medium text-gray-700">RFC</label>
                    <input
                        type="text"
                        id="candidateRfc"
                        name="candidateRfc"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-primary focus:ring-primary"
                        required
                    />
                </div>
                <div class="flex space-x-4">
                    <button
                        type="submit"
                        class="flex-1 bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                    >
                        Guardar Candidato
                    </button>
                    <button
                        type="button"
                        id="clearCandidateForm"
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300"
                    >
                        Limpiar Formulario
                    </button>
                </div>
            </form>
        </div>

        <!-- List of Surveys -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Encuestas Activas</h2>
            <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3" id="surveysList">
                <!-- Survey cards will be dynamically added here -->
            </div>
        </div>
    </div>
</div>

<script>
declare global {
    interface Window {
        freighterApi: any;
    }
}

let publicKey: string | null = null;
const CONTRACT_ID = "GC627W5PYYE5SXWAKC4LB72OYY3JMCP33N7KZ6EILCWAQNHIQDMB3O5W";

const connectWalletButton = document.getElementById('connectWallet');
const walletStatusText = document.getElementById('walletStatus');

// Wallet Connection
async function connectWallet() {
    try {
        const freighter = window.freighterApi;
        if (!freighter) {
            alert("Por favor instala Freighter wallet");
            window.open("https://www.freighter.app", "_blank");
            return;
        }

        // Verificar la red
        const network = await freighter.getNetwork();
        if (network !== "TESTNET") {
            alert("Por favor cambia a la red TESTNET en Freighter");
            return;
        }

        // Conectar wallet
        await freighter.connect();
        publicKey = await freighter.getPublicKey();
        
        if (walletStatusText && connectWalletButton) {
            walletStatusText.textContent = `Conectado: ${publicKey.slice(0, 10)}...${publicKey.slice(-10)}`;
            connectWalletButton.textContent = 'Conectado';
            connectWalletButton.classList.add('bg-green-500');
            connectWalletButton.classList.remove('bg-primary');
        }

        loadSurveys(); // Cargar encuestas al conectar
    } catch (error) {
        console.error("Error al conectar:", error);
        if (walletStatusText) {
            walletStatusText.textContent = 'Error al conectar wallet';
        }
    }
}

// Contract Interaction
async function invokeContract(method: string, args: any = {}) {
    if (!publicKey) {
        alert("Por favor conecta tu wallet primero");
        return;
    }

    try {
        const freighter = window.freighterApi;
        const transaction = await freighter.getTransaction({
            networkPassphrase: "Test SDF Network ; September 2015",
            sourceAddress: publicKey,
            contractId: CONTRACT_ID,
            method,
            args
        });

        const signedTransaction = await freighter.signTransaction(transaction);
        const response = await submitTransaction(signedTransaction);
        return response;
    } catch (error) {
        console.error("Error en la transacción:", error);
        throw error;
    }
}

// Survey Management
async function createSurvey(event: Event) {
    event.preventDefault();
    const form = event.target as HTMLFormElement;
    const formData = new FormData(form);

    try {
        await invokeContract('create_survey', {
            name: formData.get('surveyName'),
            description: formData.get('surveyDescription'),
            start_date: new Date(formData.get('startDate') as string).toISOString(),
            end_date: new Date(formData.get('endDate') as string).toISOString()
        });

        alert('Encuesta creada exitosamente');
        form.reset();
        loadSurveys();
    } catch (error) {
        alert('Error al crear la encuesta');
        console.error(error);
    }
}

async function loadSurveys() {
    try {
        const surveys = await invokeContract('get_surveys');
        const surveysContainer = document.getElementById('surveysList');
        if (!surveysContainer) return;

        surveysContainer.innerHTML = '';
        surveys.forEach((survey: any) => {
            const card = createSurveyCard(survey);
            surveysContainer.appendChild(card);
        });
    } catch (error) {
        console.error("Error al cargar encuestas:", error);
    }
}

function createSurveyCard(survey: any) {
    const div = document.createElement('div');
    div.className = 'bg-white rounded-lg shadow-lg overflow-hidden';
    div.innerHTML = `
        <div class="p-6">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">${survey.name}</h3>
            <p class="text-gray-600 mb-4">${survey.description}</p>
            <div class="space-y-3">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">Inicio:</span>
                    <span class="text-sm font-medium text-primary">${new Date(survey.start_date).toLocaleDateString()}</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-500">Fin:</span>
                    <span class="text-sm font-medium text-primary">${new Date(survey.end_date).toLocaleDateString()}</span>
                </div>
            </div>
            <div class="mt-4 space-x-2">
                <button onclick="editSurvey('${survey.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded">
                    Editar
                </button>
                <button onclick="deleteSurvey('${survey.id}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">
                    Eliminar
                </button>
            </div>
        </div>
    `;
    return div;
}

// Candidate Management
async function handleCandidateForm(event: Event) {
    event.preventDefault();
    const form = event.target as HTMLFormElement;
    const formData = new FormData(form);
    const candidateId = formData.get('candidateId');

    try {
        const method = candidateId ? 'update_candidate' : 'create_candidate';
        await invokeContract(method, {
            id: candidateId || undefined,
            name: formData.get('candidateName'),
            rfc: formData.get('candidateRfc')
        });

        alert(candidateId ? 'Candidato actualizado' : 'Candidato creado');
        form.reset();
    } catch (error) {
        alert('Error al procesar el candidato');
        console.error(error);
    }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
    connectWalletButton?.addEventListener('click', connectWallet);
    document.getElementById('createSurveyForm')?.addEventListener('submit', createSurvey);
    document.getElementById('candidateForm')?.addEventListener('submit', handleCandidateForm);
    document.getElementById('clearCandidateForm')?.addEventListener('click', () => {
        const form = document.getElementById('candidateForm') as HTMLFormElement;
        if (form) {
            form.reset();
            (document.getElementById('candidateId') as HTMLInputElement).value = '';
        }
    });
});

// Helper function to submit transaction
async function submitTransaction(signedXDR: string) {
    const response = await fetch('https://horizon-testnet.stellar.org/transactions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `tx=${signedXDR}`
    });
    return await response.json();
}
</script>