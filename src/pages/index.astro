---
import Layout from '../layouts/Layout.astro';
import WalletConnector from '../components/WalletConnector.astro';
import PasskeyConnector from '../components/PasskeyConnector.astro';

// Definir las variables que se usarÃ¡n en el cliente
const CONTRACT_ID = "GC627W5PYYE5SXWAKC4LB72OYY3JMCP33N7KZ6EILCWAQNHIQDMB3O5W";
---

<Layout title="CenVote - Sistema de VotaciÃ³n Descentralizada">
  <div class="min-h-screen bg-gradient-to-br from-slate-950 via-purple-900 to-slate-950">
    <!-- Header/Navigation -->
    <nav class="backdrop-blur-xl bg-white/5 border-b border-white/10 sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-20">
          <div class="flex items-center space-x-12">
            <div class="flex-shrink-0 flex items-center">
              <h1 class="text-3xl font-black bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">CenVote</h1>
            </div>
            <div class="hidden sm:flex sm:space-x-1">
              <a href="/users" class="nav-link px-3 py-2 rounded-lg">
                ğŸ‘¥ Usuarios
              </a>
              <a href="/candidates" class="nav-link px-3 py-2 rounded-lg">
                ğŸ¯ Candidatos
              </a>
              <a href="/surveys" class="nav-link px-3 py-2 rounded-lg">
                ğŸ“Š Encuestas
              </a>
            </div>
          </div>
          <div class="flex items-center">
            <WalletConnector />
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-16 px-4 sm:px-6 lg:px-8">
      <!-- Hero Section -->
      <div class="text-center mb-16 animate-fadeInUp">
        <h2 class="text-5xl sm:text-6xl font-black mb-6 header-gradient">
          Bienvenido a CenVote
        </h2>
        <p class="mt-6 max-w-3xl mx-auto text-xl text-gray-300 font-light">
          La plataforma de votaciÃ³n descentralizada mÃ¡s segura y transparente
        </p>
        <div class="mt-8 flex justify-center gap-4">
          <a href="/surveys" class="btn-primary">
            âœ¨ Comenzar
          </a>
          <a href="/candidates" class="btn-secondary">
            ğŸ“– Conocer MÃ¡s
          </a>
        </div>
      </div>

      <!-- Authentication Section -->
      <div class="card-glass backdrop-blur-lg bg-gradient-to-br from-blue-500/20 via-purple-500/20 to-pink-500/10 border-2 border-white/20 rounded-3xl p-12 mb-16 shadow-2xl">
        <h3 class="text-3xl font-bold text-white mb-4 flex items-center justify-center gap-3">
          ğŸ” AutenticaciÃ³n Segura
        </h3>
        <p class="text-gray-300 text-center mb-8 text-lg">Autentica usando Passkey (WebAuthn) + Freighter Wallet para mÃ¡xima seguridad</p>
        <div class="bg-white/5 rounded-2xl p-8 border border-white/10">
          <PasskeyConnector />
        </div>
      </div>

      <!-- Features Grid -->
      <div class="grid md:grid-cols-3 gap-8 mb-16">
        <!-- Users Card -->
        <a href="/users" class="card-gradient group hover:scale-105 transition-transform duration-300 p-8 rounded-2xl border border-white/20 backdrop-blur-xl hover:border-blue-500/50">
          <div class="text-5xl mb-4 group-hover:scale-110 transition-transform duration-300">ğŸ‘¥</div>
          <h3 class="text-2xl font-bold text-white mb-3">GestiÃ³n de Usuarios</h3>
          <p class="text-gray-400 text-lg">Registra y administra usuarios en el sistema con total seguridad</p>
          <div class="mt-6 text-blue-400 group-hover:translate-x-2 transition-transform">â†’ Ver mÃ¡s</div>
        </a>

        <!-- Candidates Card -->
        <a href="/candidates" class="card-gradient group hover:scale-105 transition-transform duration-300 p-8 rounded-2xl border border-white/20 backdrop-blur-xl hover:border-purple-500/50">
          <div class="text-5xl mb-4 group-hover:scale-110 transition-transform duration-300">ğŸ¯</div>
          <h3 class="text-2xl font-bold text-white mb-3">GestiÃ³n de Candidatos</h3>
          <p class="text-gray-400 text-lg">Administra candidatos para las votaciones de forma descentralizada</p>
          <div class="mt-6 text-purple-400 group-hover:translate-x-2 transition-transform">â†’ Ver mÃ¡s</div>
        </a>

        <!-- Surveys Card -->
        <a href="/surveys" class="card-gradient group hover:scale-105 transition-transform duration-300 p-8 rounded-2xl border border-white/20 backdrop-blur-xl hover:border-pink-500/50">
          <div class="text-5xl mb-4 group-hover:scale-110 transition-transform duration-300">ğŸ“Š</div>
          <h3 class="text-2xl font-bold text-white mb-3">GestiÃ³n de Encuestas</h3>
          <p class="text-gray-400 text-lg">Crea y administra encuestas de votaciÃ³n en tiempo real</p>
          <div class="mt-6 text-pink-400 group-hover:translate-x-2 transition-transform">â†’ Ver mÃ¡s</div>
        </a>
      </div>

      <!-- Stats Section -->
      <div class="grid md:grid-cols-4 gap-6 mb-16">
        <div class="card-glass p-6 text-center rounded-2xl">
          <div class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-blue-600 bg-clip-text text-transparent mb-2">100%</div>
          <p class="text-gray-400">Seguro</p>
        </div>
        <div class="card-glass p-6 text-center rounded-2xl">
          <div class="text-4xl font-bold bg-gradient-to-r from-purple-400 to-purple-600 bg-clip-text text-transparent mb-2">24/7</div>
          <p class="text-gray-400">Disponible</p>
        </div>
        <div class="card-glass p-6 text-center rounded-2xl">
          <div class="text-4xl font-bold bg-gradient-to-r from-pink-400 to-pink-600 bg-clip-text text-transparent mb-2">âˆ</div>
          <p class="text-gray-400">Escalable</p>
        </div>
        <div class="card-glass p-6 text-center rounded-2xl">
          <div class="text-4xl font-bold bg-gradient-to-r from-emerald-400 to-emerald-600 bg-clip-text text-transparent mb-2">âš¡</div>
          <p class="text-gray-400">RÃ¡pido</p>
        </div>
      </div>
    </div>
  </div>

<script>
import { freighterService } from '../services/FreighterService';

// El CONTRACT_ID se pasa desde el servidor
declare const CONTRACT_ID: string;

async function invokeContractFunction(method: string, args: any[] = []) {
  try {
    console.log('ğŸ“ Invocando funciÃ³n de contrato:', method);

    // Verificar instalaciÃ³n de Freighter
    const isInstalled = await freighterService.isFreighterInstalled();
    if (!isInstalled) {
      const shouldInstall = confirm('Freighter no estÃ¡ instalado. Â¿Deseas ir a la pÃ¡gina de instalaciÃ³n?');
      if (shouldInstall) {
        window.open('https://www.freighter.app', '_blank');
      }
      return;
    }

    // Verificar conexiÃ³n
    if (!freighterService.isConnected) {
      const shouldConnect = confirm("Debes conectar tu wallet primero. Â¿Conectar ahora?");
      if (shouldConnect) {
        const result = await freighterService.connect();
        if (!result.success) {
          alert(`âŒ ${result.message}`);
          return;
        }
      } else {
        return;
      }
    }

    // Verificar disponibilidad de la API
    const freighterApi = (window as any).freighterApi;
    if (!freighterApi) {
      alert('No se puede acceder a la API de Freighter. Por favor recarga la pÃ¡gina.');
      return;
    }

    // Obtener informaciÃ³n necesaria
    const publicKey = freighterService.publicKey;
    const networkDetails = freighterService.networkDetails;
    
    if (!publicKey || !networkDetails) {
      throw new Error("No se pudo obtener la informaciÃ³n de la wallet");
    }

    console.log('ğŸ“‹ Preparando transacciÃ³n con:', {
      network: networkDetails.network,
      publicKey: `${publicKey.slice(0, 6)}...${publicKey.slice(-6)}`,
      contractId: CONTRACT_ID,
      method,
      args
    });

    // TODO: Implementar llamada al contrato Soroban
    // Por ahora, esto es un placeholder
    console.log('âš ï¸ La integraciÃ³n con el contrato Soroban estÃ¡ pendiente');
    alert('La funcionalidad de contratos estÃ¡ en desarrollo. Tu wallet estÃ¡ conectada correctamente.');

    /* 
    // Ejemplo de cÃ³mo se verÃ­a la integraciÃ³n completa:
    const transactionXDR = await freighterApi.getTransaction({
      network: networkDetails.network,
      source: publicKey,
      contractId: CONTRACT_ID,
      method,
      args
    });

    // Firmar la transacciÃ³n
    const { signed, error } = await freighterService.signTransaction(transactionXDR);
    if (error) {
      throw new Error(error);
    }

    // Enviar la transacciÃ³n
    console.log('ğŸ“¤ Enviando transacciÃ³n firmada...');
    const txResponse = await freighterApi.signAndSubmitTransaction(signed);
    console.log("âœ… TransacciÃ³n completada:", txResponse);
    return txResponse;
    */
  } catch (err) {
    console.error("âŒ Error en invokeContractFunction:", err);
    alert(`Error en la transacciÃ³n: ${err instanceof Error ? err.message : 'Error desconocido'}`);
  }
}

// Exponer funciÃ³n globalmente para testing
(window as any).invokeContractFunction = invokeContractFunction;

// Inicializar la conexiÃ³n al cargar la pÃ¡gina
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ğŸš€ Inicializando CenVote DApp...');
  
  // Verificar si hay una sesiÃ³n de wallet guardada
  const isConnected = await freighterService.checkConnection();
  if (isConnected && freighterService.publicKey) {
    console.log('âœ… Wallet ya conectada:', `${freighterService.publicKey.slice(0, 6)}...${freighterService.publicKey.slice(-6)}`);
    
    // Intentar reconectar automÃ¡ticamente
    const result = await freighterService.connect();
    if (result.success) {
      console.log('âœ… ReconexiÃ³n automÃ¡tica exitosa');
    } else {
      console.log('âš ï¸ No se pudo reconectar automÃ¡ticamente:', result.message);
    }
  } else {
    console.log('â„¹ï¸ No hay wallet conectada. Por favor conecta tu Freighter wallet.');
  }
});
</script>
</Layout>