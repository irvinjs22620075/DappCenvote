
<div class="flex items-center space-x-4" id="walletConnector">
  <button 
    id="connectWalletBtn"
    class="relative px-6 py-2.5 rounded-lg font-semibold text-white transition-all duration-300 overflow-hidden group"
  >
    <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-700 group-hover:from-blue-700 group-hover:to-blue-800 transition-all duration-300"></div>
    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-blue-500/20 transition-opacity duration-300"></div>
    <span class="relative inline-flex items-center gap-2">
      ðŸ”— <span>Conectar Wallet</span>
    </span>
  </button>
  
  <div id="walletStatus" class="hidden items-center gap-3 px-4 py-2.5 rounded-lg bg-emerald-500/20 border border-emerald-500/50 group">
    <span class="relative inline-flex h-3 w-3">
      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
      <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
    </span>
    <div class="flex flex-col gap-1">
      <div class="flex items-center gap-2">
        <p id="walletAddress" class="text-sm font-semibold text-emerald-300 cursor-pointer hover:text-emerald-200 transition-colors" title="Click para copiar"></p>
        <span id="networkBadge" class="text-xs px-2 py-0.5 rounded-full bg-blue-500/30 text-blue-200 font-medium">TESTNET</span>
      </div>
      <p id="walletBalance" class="text-xs text-emerald-400/80"></p>
    </div>
    <button id="disconnectBtn" class="ml-2 p-1.5 rounded-lg bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 text-red-300 transition-all duration-200" title="Desconectar wallet">
      ðŸ”Œ
    </button>
  </div>

  <div id="loadingIndicator" class="hidden items-center gap-2 px-4 py-2.5 rounded-lg bg-blue-500/20 border border-blue-500/50">
    <div class="animate-spin h-4 w-4 border-2 border-blue-400 border-t-transparent rounded-full"></div>
    <span class="text-sm text-blue-300">Conectando...</span>
  </div>
</div>

<script is:inline>
(async function() {
  // Guard: Only run in browser
  if (typeof window === 'undefined') {
    console.log('SSR: Skipping wallet connector initialization');
    return;
  }

  try {
    // Dynamic import to ensure browser-only execution
    const { freighterService } = await import('/src/services/FreighterService.ts');

    const connectButton = document.getElementById('connectWalletBtn');
    const disconnectButton = document.getElementById('disconnectBtn');
    const statusElement = document.getElementById('walletStatus');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const walletAddress = document.getElementById('walletAddress');
    const walletBalance = document.getElementById('walletBalance');
    const networkBadge = document.getElementById('networkBadge');

    function showLoading(show) {
      if (!loadingIndicator || !connectButton || !statusElement) return;
      
      if (show) {
        loadingIndicator.classList.remove('hidden');
        loadingIndicator.classList.add('flex');
        connectButton.classList.add('hidden');
        statusElement.classList.add('hidden');
      } else {
        loadingIndicator.classList.add('hidden');
        loadingIndicator.classList.remove('flex');
      }
    }

    async function updateBalance() {
      if (!walletBalance) return;
      
      const balance = await freighterService.getAccountBalance();
      if (balance) {
        walletBalance.textContent = `ðŸ’° ${parseFloat(balance.balance).toFixed(2)} ${balance.asset}`;
      } else {
        walletBalance.textContent = '';
      }
    }

    async function updateUI(isConnected, publicKey, network) {
      if (!connectButton || !statusElement) return;

      if (isConnected && publicKey) {
        // Mostrar estado conectado
        connectButton.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r from-emerald-600 to-emerald-700 group-hover:from-emerald-700 group-hover:to-emerald-800 transition-all duration-300"></div><span class="relative inline-flex items-center gap-2">âœ… <span>Conectada</span></span>`;
        connectButton.disabled = true;
        connectButton.classList.remove('hidden');
        
        if (walletAddress) {
          const shortAddress = `${publicKey.slice(0, 6)}...${publicKey.slice(-6)}`;
          walletAddress.textContent = shortAddress;
          walletAddress.setAttribute('data-full-address', publicKey);
        }

        if (networkBadge && network) {
          networkBadge.textContent = network;
          networkBadge.className = network === 'TESTNET' 
            ? 'text-xs px-2 py-0.5 rounded-full bg-blue-500/30 text-blue-200 font-medium'
            : 'text-xs px-2 py-0.5 rounded-full bg-yellow-500/30 text-yellow-200 font-medium';
        }

        statusElement.classList.remove('hidden');
        statusElement.classList.add('flex');

        // Actualizar balance
        await updateBalance();
      } else {
        // Mostrar estado desconectado
        connectButton.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-700 group-hover:from-blue-700 group-hover:to-blue-800 transition-all duration-300"></div><div class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-blue-500/20 transition-opacity duration-300"></div><span class="relative inline-flex items-center gap-2">ðŸ”— <span>Conectar Wallet</span></span>`;
        connectButton.disabled = false;
        connectButton.classList.remove('hidden');
        statusElement.classList.add('hidden');
        statusElement.classList.remove('flex');

        if (walletBalance) {
          walletBalance.textContent = '';
        }
      }
      
      showLoading(false);
    }

    async function handleConnect() {
      try {
        showLoading(true);

        // Verificar si Freighter estÃ¡ instalado
        const isInstalled = await freighterService.isFreighterInstalled();
        if (!isInstalled) {
          showLoading(false);
          const shouldInstall = confirm('Freighter no estÃ¡ instalado. Â¿Deseas ir a la pÃ¡gina de instalaciÃ³n?');
          if (shouldInstall) {
            window.open('https://www.freighter.app', '_blank');
          }
          return;
        }

        // Intentar conectar
        const result = await freighterService.connect();
        console.log('Resultado de conexiÃ³n:', result);
        
        if (!result.success) {
          showLoading(false);
          alert(`âŒ ${result.message}`);
          await updateUI(false);
          return;
        }

        const networkDetails = freighterService.networkDetails;
        await updateUI(true, result.publicKey, networkDetails?.network);
        
        // Mostrar notificaciÃ³n de Ã©xito
        console.log('âœ… Wallet conectada exitosamente');
      } catch (error) {
        showLoading(false);
        console.error('Error al conectar:', error);
        alert('âŒ Error inesperado al conectar con Freighter');
        await updateUI(false);
      }
    }

    async function handleDisconnect() {
      if (!confirm('Â¿Deseas desconectar tu wallet?')) return;
      
      try {
        await freighterService.disconnect();
        await updateUI(false);
        console.log('âœ… Wallet desconectada');
      } catch (error) {
        console.error('Error al desconectar:', error);
      }
    }

    function copyAddressToClipboard() {
      if (!walletAddress) return;
      
      const fullAddress = walletAddress.getAttribute('data-full-address');
      if (fullAddress) {
        navigator.clipboard.writeText(fullAddress).then(() => {
          const originalText = walletAddress.textContent;
          walletAddress.textContent = 'âœ“ Copiado!';
          setTimeout(() => {
            if (walletAddress && originalText) {
              walletAddress.textContent = originalText;
            }
          }, 1500);
        }).catch(err => {
          console.error('Error al copiar:', err);
        });
      }
    }

    // Initialize on DOMContentLoaded
    async function initialize() {
      console.log('ðŸ”„ Verificando conexiÃ³n existente...');
      
      const isConnected = await freighterService.checkConnection();
      if (isConnected && freighterService.publicKey) {
        const networkDetails = freighterService.networkDetails;
        await updateUI(true, freighterService.publicKey, networkDetails?.network);
        console.log('âœ… Reconectado automÃ¡ticamente');
      }

      // Attach event listeners
      if (connectButton) connectButton.addEventListener('click', handleConnect);
      if (disconnectButton) disconnectButton.addEventListener('click', handleDisconnect);
      if (walletAddress) walletAddress.addEventListener('click', copyAddressToClipboard);

      // Listen for wallet events
      window.addEventListener('walletConnected', async (event) => {
        const { publicKey, network } = event.detail;
        await updateUI(true, publicKey, network);
      });

      window.addEventListener('walletDisconnected', async () => {
        await updateUI(false);
      });
    }

    // Run initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initialize);
    } else {
      initialize();
    }

  } catch (error) {
    console.error('Error loading wallet connector:', error);
  }
})();
</script>