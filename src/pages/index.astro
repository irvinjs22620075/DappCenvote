---
import Layout from '../layouts/Layout.astro';
---

<Layout title="CenVote - Sistema de Votación Descentralizada">
  <div class="min-h-screen bg-gray-100">
    <!-- Header/Navigation -->
    <nav class="bg-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex">
            <div class="flex-shrink-0 flex items-center">
              <h1 class="text-2xl font-bold text-primary">CenVote</h1>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
              <a href="/users" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Usuarios
              </a>
              <a href="/candidates" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Candidatos
              </a>
              <a href="/surveys" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Encuestas
              </a>
            </div>
          </div>
          <div class="flex items-center">
            <button id="connectWalletBtn"
              class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
              Conectar Wallet
            </button>
            <p id="walletStatus" class="ml-4 text-sm text-gray-600"></p>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-4xl font-extrabold text-gray-900 mb-4">
          Bienvenido a CenVote
        </h2>
        <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500 sm:mt-4">
          Sistema de votación descentralizado seguro y transparente
        </p>
        <div class="mt-10 grid gap-6 md:grid-cols-3">
          <a href="/users"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gestión de Usuarios</h3>
            <p class="text-gray-600">Registra y administra usuarios en el sistema</p>
          </a>
          <a href="/candidates"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gestión de Candidatos</h3>
            <p class="text-gray-600">Administra los candidatos para las votaciones</p>
          </a>
          <a href="/surveys"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gestión de Encuestas</h3>
            <p class="text-gray-600">Crea y administra encuestas de votación</p>
          </a>
        </div>
      </div>
    </div>
  </div>

<script>
  type FreighterApi = {
    getNetwork: () => Promise<string>;
    connect: () => Promise<void>;
    getPublicKey: () => Promise<string>;
    signAndSubmitTransaction: (xdr: string) => Promise<any>;
    getTransaction: (params: {
      network: string;
      source: string;
      contractId: string;
      method: string;
      args: any[];
    }) => Promise<string>;
  }

  declare global {
    interface Window {
      freighterApi?: FreighterApi;
    }
  }

  const CONTRACT_ID: string = "GC627W5PYYE5SXWAKC4LB72OYY3JMCP33N7KZ6EILCWAQNHIQDMB3O5W";
  let publicKey: string | null = null;

  async function updateWalletUI(status: string, isConnected: boolean = false) {
    const walletBtn = document.getElementById('connectWalletBtn');
    const walletStatus = document.getElementById('walletStatus');
    
    if (walletBtn && walletStatus) {
      if (isConnected) {
        walletBtn.textContent = 'Wallet Conectada';
        walletBtn.classList.add('bg-green-500');
        walletBtn.classList.remove('bg-primary');
        walletStatus.textContent = status;
        walletStatus.classList.add('text-green-600');
      } else {
        walletBtn.textContent = 'Conectar Wallet';
        walletBtn.classList.remove('bg-green-500');
        walletBtn.classList.add('bg-primary');
        walletStatus.textContent = status;
        walletStatus.classList.add('text-red-600');
      }
    }
  }

  async function connectWallet() {
    try {
      const freighter = window.freighterApi;
      if (!freighter) {
        updateWalletUI('Freighter no está instalado');
        window.open("https://www.freighter.app", "_blank");
        return;
      }

      const network = await freighter.getNetwork();
      if (network !== "TESTNET") {
        updateWalletUI('Por favor cambia a la red TESTNET');
        return;
      }

      await freighter.connect();
      const newPublicKey = await freighter.getPublicKey();
      publicKey = newPublicKey;
      updateWalletUI(`Conectado: ${newPublicKey.slice(0, 10)}...`, true);

    } catch (error) {
      console.error("Error al conectar wallet:", error);
      updateWalletUI('Error al conectar wallet');
    }
  }

  async function invokeContractFunction(method: string, args: any[] = []) {
    if (!publicKey) {
      const shouldConnect = confirm("Debes conectar tu wallet primero. ¿Conectar ahora?");
      if (shouldConnect) {
        await connectWallet();
      }
      if (!publicKey) return;
    }

    try {
      const freighter = window.freighterApi;
      if (!freighter) throw new Error("Freighter no está disponible");

      const transactionXDR = await freighter.getTransaction({
        network: "TESTNET",
        source: publicKey,
        contractId: CONTRACT_ID,
        method,
        args
      });

      const txResponse = await freighter.signAndSubmitTransaction(transactionXDR);
      return txResponse;
    } catch (err) {
      console.error("Error en invokeContractFunction:", err);
      throw err;
    }
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    if (connectWalletBtn) {
      connectWalletBtn.addEventListener('click', connectWallet);
    }
  });
</script>
</Layout>