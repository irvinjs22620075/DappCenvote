---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Gesti√≥n de Encuestas - CenVote">
  <div class="min-h-screen bg-gradient-to-br from-slate-950 via-purple-900 to-slate-950 py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
      <div class="card-glass backdrop-blur-lg p-8 rounded-3xl border-2 border-white/20">
        <h1 class="text-4xl font-black header-gradient mb-8">üìä Gesti√≥n de Encuestas</h1>
        
        <!-- Formulario de Encuesta -->
        <form id="surveyForm" class="space-y-6 mb-12">
          <input type="hidden" id="surveyId" name="surveyId">
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label for="name" class="block text-sm font-semibold text-white mb-2">Nombre de la Encuesta</label>
              <input type="text" id="name" name="name" required
                class="input-modern">
            </div>
            <div>
              <label for="description" class="block text-sm font-semibold text-white mb-2">Descripci√≥n</label>
              <textarea id="description" name="description" rows="4" required
                class="input-modern resize-none"></textarea>
            </div>
            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
              <div>
                <label for="start_date" class="block text-sm font-semibold text-white mb-2">Fecha de Inicio</label>
                <input type="datetime-local" id="start_date" name="start_date" required
                  class="input-modern">
              </div>
              <div>
                <label for="end_date" class="block text-sm font-semibold text-white mb-2">Fecha de Fin</label>
                <input type="datetime-local" id="end_date" name="end_date" required
                  class="input-modern">
              </div>
            </div>
            <div>
              <label for="candidates" class="block text-sm font-semibold text-white mb-2">Candidatos (mant√©n presionado Ctrl/Cmd para seleccionar m√∫ltiples)</label>
              <select multiple id="candidates" name="candidates" size="5"
                class="input-modern h-auto">
                <!-- Los candidatos se cargar√°n aqu√≠ -->
              </select>
            </div>
          </div>
          <div class="flex justify-end space-x-4 pt-4">
            <button type="button" id="connectWalletBtn"
              class="btn-primary">
              üîó Conectar Wallet
            </button>
            <button type="button" id="cancelBtn" style="display: none;"
              class="px-6 py-2 rounded-lg font-semibold transition-all duration-300 bg-gradient-to-r from-gray-600 to-gray-700 text-white hover:from-gray-700 hover:to-gray-800">
              ‚ùå Cancelar
            </button>
            <button type="submit"
              class="btn-accent">
              <span id="submitBtnText">‚ú® Crear Encuesta</span>
            </button>
          </div>
        </form>

        <!-- Lista de Encuestas -->
        <div class="mt-12">
          <h2 class="text-2xl font-bold text-white mb-6 flex items-center gap-2">
            <span class="text-3xl">üó≥Ô∏è</span> Encuestas Activas
          </h2>
          <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3" id="surveysList">
            <!-- Las encuestas se cargar√°n aqu√≠ -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Votaci√≥n -->
  <div id="voteModal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="card-glass max-w-2xl w-full p-8 rounded-3xl border-2 border-white/20 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h2 class="text-3xl font-bold text-white mb-2" id="modalSurveyName"></h2>
          <p class="text-gray-300" id="modalSurveyDescription"></p>
        </div>
        <button onclick="closeVoteModal()" class="text-white hover:text-red-400 text-2xl">‚úï</button>
      </div>
      
      <div id="voteContent">
        <!-- Se cargar√° din√°micamente -->
      </div>
    </div>
  </div>
</Layout>

<script>
  let publicKey = null;
  let isEditing = false;
  let editingId = null;
  let currentSurveyId = null;

  // Conexi√≥n con Freighter
  import { freighterService } from '../../services/FreighterService';

  // Auto-detectar wallet conectada
  async function autoDetectWallet() {
    if (freighterService.publicKey) {
      publicKey = freighterService.publicKey;
      updateWalletButton(true);
      console.log('‚úÖ Wallet auto-detectada:', publicKey.slice(0, 8) + '...');
    } else {
      const isConnected = await freighterService.checkConnection();
      if (isConnected) {
        const result = await freighterService.connect();
        if (result.success) {
          publicKey = result.publicKey;
          updateWalletButton(true);
          console.log('‚úÖ Wallet reconectada autom√°ticamente');
        }
      }
    }
  }

  // Actualizar bot√≥n de wallet
  function updateWalletButton(connected) {
    const btn = document.getElementById('connectWalletBtn');
    if (connected && publicKey) {
      btn.textContent = `‚úÖ ${publicKey.slice(0, 6)}...${publicKey.slice(-4)}`;
      btn.classList.remove('btn-primary');
      btn.classList.add('bg-green-600', 'hover:bg-green-700');
    } else {
      btn.textContent = 'üîó Conectar Wallet';
      btn.classList.remove('bg-green-600', 'hover:bg-green-700');
      btn.classList.add('btn-primary');
    }
  }

  // Escuchar eventos de wallet
  window.addEventListener('walletConnected', (event: any) => {
    publicKey = event.detail.publicKey;
    updateWalletButton(true);
    console.log('üì° Evento de wallet conectada recibido');
  });

  window.addEventListener('walletDisconnected', () => {
    publicKey = null;
    updateWalletButton(false);
    console.log('üì° Evento de wallet desconectada recibido');
  });

  async function connectWallet() {
    try {
      const result = await freighterService.connect();
      
      if (result.success) {
        publicKey = result.publicKey;
        updateWalletButton(true);
        
        if (publicKey === freighterService.expectedPublicKey) {
            console.log('‚úÖ Cuenta verificada en formulario de encuestas');
        }
      } else {
        alert(result.message);
      }

    } catch (error) {
      console.error("Error al conectar wallet:", error);
      alert("Error al conectar con Freighter");
    }
  }

  // Cargar candidatos para el selector
  async function loadCandidateOptions() {
    try {
      const response = await fetch('http://localhost:3000/api/candidates');
      const candidates = await response.json();
      const selectElement = document.getElementById('candidates');
      
      selectElement.innerHTML = candidates.map(candidate => `
        <option value="${candidate._id}" class="py-2">${candidate.name} (${candidate.rfc})</option>
      `).join('');
    } catch (error) {
      console.error('Error al cargar candidatos:', error);
    }
  }

  // Cargar encuestas
  async function loadSurveys() {
    try {
      const response = await fetch('http://localhost:3000/api/surveys');
      const surveys = await response.json();
      const surveysList = document.getElementById('surveysList');
      
      if (surveys.length === 0) {
        surveysList.innerHTML = `
          <div class="col-span-full text-center text-gray-400 py-12">
            No hay encuestas creadas a√∫n
          </div>
        `;
        return;
      }
      
      surveysList.innerHTML = surveys.map(survey => {
        const startDate = new Date(survey.start_date);
        const endDate = new Date(survey.end_date);
        const now = new Date();
        const isActive = now >= startDate && now <= endDate;
        
        return `
          <div class="card-gradient p-6 rounded-2xl border border-white/20 hover:border-white/40 transition-all">
            <div class="flex items-start justify-between mb-4">
              <h3 class="text-xl font-bold text-white">${survey.name}</h3>
              <span class="px-3 py-1 rounded-full text-xs font-semibold ${isActive ? 'bg-green-500/20 text-green-300' : 'bg-gray-500/20 text-gray-300'}">
                ${isActive ? 'üü¢ Activa' : '‚ö´ Inactiva'}
              </span>
            </div>
            <p class="text-gray-300 text-sm mb-4 line-clamp-2">${survey.description}</p>
            <div class="space-y-2 mb-4">
              <p class="text-xs text-gray-400">
                üìÖ Inicio: ${startDate.toLocaleString('es-MX')}
              </p>
              <p class="text-xs text-gray-400">
                üìÖ Fin: ${endDate.toLocaleString('es-MX')}
              </p>
              <p class="text-xs text-purple-300">
                üë• ${survey.candidates ? survey.candidates.length : 0} candidatos
              </p>
            </div>
            <div class="flex gap-2 flex-wrap">
              <button onclick="openVoteModal('${survey._id}')"
                class="flex-1 btn-primary text-sm py-2 ${!isActive ? 'opacity-50 cursor-not-allowed' : ''}"
                ${!isActive ? 'disabled' : ''}>
                üó≥Ô∏è Votar
              </button>
              <button onclick="editSurvey('${survey._id}')"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-4 rounded-lg transition-all">
                ‚úèÔ∏è Editar
              </button>
              <button onclick="deleteSurvey('${survey._id}')"
                class="flex-1 bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-4 rounded-lg transition-all">
                üóëÔ∏è Eliminar
              </button>
            </div>
          </div>
        `;
      }).join('');
    } catch (error) {
      console.error('Error al cargar encuestas:', error);
    }
  }

  // Abrir modal de votaci√≥n
  async function openVoteModal(surveyId) {
    currentSurveyId = surveyId;
    
    // Verificar que el usuario tenga wallet conectada
    if (!publicKey) {
      const shouldConnect = confirm('Necesitas conectar tu wallet para votar. ¬øConectar ahora?');
      if (shouldConnect) {
        await connectWallet();
        if (!publicKey) return;
      } else {
        return;
      }
    }
    
    try {
      // Cargar informaci√≥n de la encuesta
      const surveyResponse = await fetch(`http://localhost:3000/api/surveys/${surveyId}`);
      const survey = await surveyResponse.json();
      
      // Verificar si ya vot√≥
      const voteCheckResponse = await fetch(`http://localhost:3000/api/surveys/${surveyId}/check-vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ voterAddress: publicKey })
      });
      const { hasVoted } = await voteCheckResponse.json();
      
      // Cargar resultados
      const resultsResponse = await fetch(`http://localhost:3000/api/surveys/${surveyId}/results`);
      const results = await resultsResponse.json();
      
      // Mostrar en modal
      document.getElementById('modalSurveyName').textContent = survey.name;
      document.getElementById('modalSurveyDescription').textContent = survey.description;
      
      const voteContent = document.getElementById('voteContent');
      
      if (hasVoted) {
        // Mostrar solo resultados si ya vot√≥
        voteContent.innerHTML = `
          <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-4 mb-6">
            <p class="text-yellow-300 font-semibold">‚úì Ya has votado en esta encuesta</p>
          </div>
          ${renderResults(results)}
        `;
      } else {
        // Mostrar opciones de voto
        voteContent.innerHTML = `
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-white mb-4">Selecciona tu candidato:</h3>
            <div class="space-y-3">
              ${results.results.map(result => `
                <button onclick="vote('${result.candidateId}')"
                  class="w-full text-left p-4 rounded-xl bg-white/10 hover:bg-white/20 border border-white/20 hover:border-blue-400 transition-all group">
                  <div class="flex items-center justify-between">
                    <span class="text-white font-semibold group-hover:text-blue-300">${result.candidateName}</span>
                    <span class="text-2xl group-hover:scale-110 transition-transform">üëç</span>
                  </div>
                </button>
              `).join('')}
            </div>
          </div>
          <div class="border-t border-white/20 pt-6">
            <h4 class="text-sm font-semibold text-gray-400 mb-3">Resultados parciales:</h4>
            ${renderResults(results)}
          </div>
        `;
      }
      
      document.getElementById('voteModal').classList.remove('hidden');
    } catch (error) {
      console.error('Error al abrir modal:', error);
      alert('Error al cargar informaci√≥n de la encuesta');
    }
  }

  // Renderizar resultados
  function renderResults(results) {
    if (results.totalVotes === 0) {
      return '<p class="text-gray-400 text-sm">No hay votos a√∫n</p>';
    }
    
    return `
      <div class="space-y-3">
        <p class="text-sm text-gray-400 mb-3">Total de votos: <span class="text-white font-bold">${results.totalVotes}</span></p>
        ${results.results.map(result => `
          <div>
            <div class="flex justify-between items-center mb-1">
              <span class="text-white text-sm font-medium">${result.candidateName}</span>
              <span class="text-gray-300 text-sm">${result.votes} votos (${result.percentage}%)</span>
            </div>
            <div class="w-full bg-white/10 rounded-full h-3 overflow-hidden">
              <div class="bg-gradient-to-r from-blue-500 to-purple-500 h-full rounded-full transition-all duration-500" 
                   style="width: ${result.percentage}%"></div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  async function vote(candidateId) {
    if (!confirm(`¬øConfirmas tu voto?`)) {
      return;
    }
    
    try {
      // Guardar voto en MongoDB

      const response = await fetch(`http://localhost:3000/api/surveys/${currentSurveyId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          candidateId,
          voterAddress: publicKey
        })
      });
      
      const data = await response.json();
      
      if (response.ok) {
        alert('¬°Voto registrado exitosamente!');
        // Recargar el modal para mostrar resultados
        openVoteModal(currentSurveyId);
      } else {
        alert(data.error || 'Error al registrar voto');
      }
    } catch (error) {
      console.error('Error al votar:', error);
      alert('Error al registrar voto: ' + error.message);
    }
  }

  // Cerrar modal
  function closeVoteModal() {
    document.getElementById('voteModal').classList.add('hidden');
    currentSurveyId = null;
  }

  // Editar encuesta
  async function editSurvey(id) {
    try {
      const response = await fetch(`http://localhost:3000/api/surveys/${id}`);
      const survey = await response.json();
      
      // Llenar el formulario
      document.getElementById('surveyId').value = survey._id;
      document.getElementById('name').value = survey.name;
      document.getElementById('description').value = survey.description;
      
      // Formatear fechas para datetime-local
      const startDate = new Date(survey.start_date);
      const endDate = new Date(survey.end_date);
      document.getElementById('start_date').value = formatDateTimeLocal(startDate);
      document.getElementById('end_date').value = formatDateTimeLocal(endDate);
      
      // Seleccionar candidatos
      const select = document.getElementById('candidates');
      Array.from(select.options).forEach(option => {
        option.selected = survey.candidates.includes(option.value);
      });
      
      publicKey = survey.created_by;
      
      // Cambiar el bot√≥n de submit
      isEditing = true;
      editingId = id;
      document.getElementById('submitBtnText').textContent = 'üíæ Actualizar Encuesta';
      document.getElementById('cancelBtn').style.display = 'inline-block';
      
      // Scroll al formulario
      document.getElementById('surveyForm').scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
      console.error('Error al cargar encuesta:', error);
      alert('Error al cargar datos de la encuesta');
    }
  }

  // Eliminar encuesta
  async function deleteSurvey(id) {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar esta encuesta?')) {
      return;
    }
    
    try {
      const response = await fetch(`http://localhost:3000/api/surveys/${id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        alert('Encuesta eliminada exitosamente');
        loadSurveys();
      } else {
        throw new Error('Error al eliminar encuesta');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar encuesta');
    }
  }

  // Cancelar edici√≥n
  function cancelEdit() {
    isEditing = false;
    editingId = null;
    document.getElementById('surveyForm').reset();
    document.getElementById('surveyId').value = '';
    document.getElementById('submitBtnText').textContent = '‚ú® Crear Encuesta';
    document.getElementById('cancelBtn').style.display = 'none';
    
    // Restaurar la wallet conectada si existe
    if (freighterService.publicKey) {
      publicKey = freighterService.publicKey;
      updateWalletButton(true);
    } else {
      publicKey = null;
      updateWalletButton(false);
    }
  }

  // Formatear fecha para input datetime-local
  function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }
  // Crear o actualizar encuesta
  document.getElementById('surveyForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const selectedCandidates = document.getElementById('candidates').selectedOptions;
    const candidatesArray = Array.from(selectedCandidates).map(option => option.value);
    
    if (candidatesArray.length === 0) {
      alert('Debes seleccionar al menos un candidato');
      return;
    }
    
    const surveyData = {
      name: formData.get('name'),
      description: formData.get('description'),
      start_date: formData.get('start_date'),
      end_date: formData.get('end_date'),
      candidates: candidatesArray,
      created_by: publicKey || 'admin'  // Opcional: usar wallet o marcar como admin
    };

    try {
      // Guardar en MongoDB

      const url = isEditing 
        ? `http://localhost:3000/api/surveys/${editingId}`
        : 'http://localhost:3000/api/surveys';
        
      const method = isEditing ? 'PUT' : 'POST';
      
      const response = await fetch(url, {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(surveyData)
      });

      const data = await response.json();

      if (response.ok) {
        alert(isEditing ? 'Encuesta actualizada exitosamente' : 'Encuesta creada exitosamente');
        cancelEdit();
        loadSurveys();
      } else {
        // Mostrar el error espec√≠fico del backend
        const errorMsg = data.error || 'Error desconocido al guardar encuesta';
        throw new Error(errorMsg);
      }
    } catch (error) {
      console.error('Error completo:', error);
      alert('Error al guardar encuesta: ' + error.message);
    }
  });

  // Event Listeners
  document.addEventListener('DOMContentLoaded', async () => {
    document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
    document.getElementById('cancelBtn').addEventListener('click', cancelEdit);
    
    // Auto-detectar wallet al cargar
    await autoDetectWallet();
    
    loadCandidateOptions();
    loadSurveys();
  });

  // Hacer funciones globales
  window.editSurvey = editSurvey;
  window.deleteSurvey = deleteSurvey;
  window.openVoteModal = openVoteModal;
  window.closeVoteModal = closeVoteModal;
  window.vote = vote;
</script>
</Layout>