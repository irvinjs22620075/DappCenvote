---
import Layout from '../layouts/Layout.astro';
import WalletConnector from '../components/WalletConnector.astro';
import PasskeyConnector from '../components/PasskeyConnector.astro';

// Definir las variables que se usar谩n en el cliente
const CONTRACT_ID = "GC627W5PYYE5SXWAKC4LB72OYY3JMCP33N7KZ6EILCWAQNHIQDMB3O5W";
---

<Layout title="CenVote - Sistema de Votaci贸n Descentralizada">
  <div class="min-h-screen bg-gray-100">
    <!-- Header/Navigation -->
    <nav class="bg-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex">
            <div class="flex-shrink-0 flex items-center">
              <h1 class="text-2xl font-bold text-primary">CenVote</h1>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
              <a href="/users" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Usuarios
              </a>
              <a href="/candidates" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Candidatos
              </a>
              <a href="/surveys" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Encuestas
              </a>
            </div>
          </div>
          <div class="flex items-center">
            <WalletConnector />
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-4xl font-extrabold text-gray-900 mb-4">
          Bienvenido a CenVote
        </h2>
        <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500 sm:mt-4">
          Sistema de votaci贸n descentralizado seguro y transparente
        </p>

        <!-- Passkey + Freighter Authentication Section -->
        <div class="mt-12 mb-12 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-8 border-2 border-blue-200">
          <h3 class="text-2xl font-bold text-gray-900 mb-6"> Autenticaci贸n Segura</h3>
          <p class="text-gray-600 mb-8">Autentica usando Passkey (WebAuthn) + Freighter Wallet</p>
          <PasskeyConnector />
        </div>

        <div class="mt-10 grid gap-6 md:grid-cols-3">
          <a href="/users"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gesti贸n de Usuarios</h3>
            <p class="text-gray-600">Registra y administra usuarios en el sistema</p>
          </a>
          <a href="/candidates"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gesti贸n de Candidatos</h3>
            <p class="text-gray-600">Administra los candidatos para las votaciones</p>
          </a>
          <a href="/surveys"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gesti贸n de Encuestas</h3>
            <p class="text-gray-600">Crea y administra encuestas de votaci贸n</p>
          </a>
        </div>
      </div>
    </div>
  </div>

<script>
import { freighterService } from '../services/FreighterService';

// El CONTRACT_ID se pasa desde el servidor
declare const CONTRACT_ID: string;

async function invokeContractFunction(method: string, args: any[] = []) {
  try {
    // Verificar instalaci贸n de Freighter
    if (!(window as any).freighter) {
      alert('Por favor instala Freighter Wallet');
      window.open('https://www.freighter.app', '_blank');
      return;
    }

    // Verificar conexi贸n
    if (!freighterService.isConnected) {
      const shouldConnect = confirm("Debes conectar tu wallet primero. 驴Conectar ahora?");
      if (shouldConnect) {
        const result = await freighterService.connect();
        if (!result.success) {
          alert(result.message);
          return;
        }
      } else {
        return;
      }
    }

    // Verificar disponibilidad de la API
    const freighter = (window as any).freighterApi;
    if (!freighter) {
      alert('No se puede acceder a la API de Freighter. Por favor recarga la p谩gina.');
      return;
    }

    // Obtener informaci贸n necesaria
    const publicKey = freighterService.publicKey;
    const networkDetails = freighterService.networkDetails;
    
    if (!publicKey || !networkDetails) {
      throw new Error("No se pudo obtener la informaci贸n de la wallet");
    }

    console.log('Preparando transacci贸n con:', {
      network: networkDetails.network,
      publicKey,
      contractId: CONTRACT_ID,
      method,
      args
    });

    // Crear la transacci贸n
    const transactionXDR = await freighter.getTransaction({
      network: networkDetails.network,
      source: publicKey,
      contractId: CONTRACT_ID,
      method,
      args
    });

    console.log('TransactionXDR generado:', transactionXDR);

    // Firmar la transacci贸n
    const { signed, error } = await freighterService.signTransaction(transactionXDR);
    if (error) {
      throw new Error(error);
    }

    // Enviar la transacci贸n
    console.log('Enviando transacci贸n firmada...');
    const txResponse = await freighter.signAndSubmitTransaction(signed);
    console.log("Transacci贸n completada:", txResponse);
    return txResponse;
  } catch (err) {
    console.error("Error en invokeContractFunction:", err);
    alert(`Error en la transacci贸n: ${err instanceof Error ? err.message : 'Error desconocido'}`);
  }
}

// Inicializar la conexi贸n si ya existe
document.addEventListener('DOMContentLoaded', async () => {
  const isAvailable = await freighterService.checkConnection();
  if (isAvailable && freighterService.isConnected) {
    const result = await freighterService.connect();
    if (!result.success) {
      console.error('Error reconectando con Freighter:', result.message);
    }
  }
});
</script>
</Layout>