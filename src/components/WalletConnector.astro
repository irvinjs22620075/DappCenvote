
<div class="flex items-center space-x-4" id="walletConnector">
  <button 
    id="connectWalletBtn"
    class="relative px-6 py-2.5 rounded-lg font-semibold text-white transition-all duration-300 overflow-hidden group"
  >
    <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-700 group-hover:from-blue-700 group-hover:to-blue-800 transition-all duration-300"></div>
    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-blue-500/20 transition-opacity duration-300"></div>
    <span class="relative inline-flex items-center gap-2">
      üîó <span>Conectar Wallet</span>
    </span>
  </button>
  
  <div id="walletStatus" class="hidden items-center gap-3 px-4 py-2.5 rounded-lg bg-emerald-500/20 border border-emerald-500/50 group">
    <span class="relative inline-flex h-3 w-3">
      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
      <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
    </span>
    <div class="flex flex-col gap-1">
      <div class="flex items-center gap-2">
        <p id="walletAddress" class="text-sm font-semibold text-emerald-300 cursor-pointer hover:text-emerald-200 transition-colors" title="Click para copiar"></p>
        <span id="networkBadge" class="text-xs px-2 py-0.5 rounded-full bg-blue-500/30 text-blue-200 font-medium">TESTNET</span>
      </div>
      <p id="walletBalance" class="text-xs text-emerald-400/80"></p>
    </div>
    <button id="disconnectBtn" class="ml-2 p-1.5 rounded-lg bg-red-500/20 hover:bg-red-500/30 border border-red-500/50 text-red-300 transition-all duration-200" title="Desconectar wallet">
      üîå
    </button>
  </div>

  <div id="loadingIndicator" class="hidden items-center gap-2 px-4 py-2.5 rounded-lg bg-blue-500/20 border border-blue-500/50">
    <div class="animate-spin h-4 w-4 border-2 border-blue-400 border-t-transparent rounded-full"></div>
    <span class="text-sm text-blue-300">Conectando...</span>
  </div>
</div>

<script>
import { freighterService } from '../services/FreighterService';

console.log('üöÄ WalletConnector script cargado');

const connectButton = document.getElementById('connectWalletBtn') as HTMLButtonElement | null;
const disconnectButton = document.getElementById('disconnectBtn') as HTMLButtonElement | null;
const statusElement = document.getElementById('walletStatus') as HTMLElement | null;
const loadingIndicator = document.getElementById('loadingIndicator') as HTMLElement | null;
const walletAddress = document.getElementById('walletAddress') as HTMLElement | null;
const walletBalance = document.getElementById('walletBalance') as HTMLElement | null;
const networkBadge = document.getElementById('networkBadge') as HTMLElement | null;

if (connectButton) {
  console.log('‚úÖ Bot√≥n de conectar encontrado');
} else {
  console.error('‚ùå Bot√≥n de conectar NO encontrado');
}

function showLoading(show: boolean): void {
  if (!loadingIndicator || !connectButton || !statusElement) return;
  
  if (show) {
    loadingIndicator.classList.remove('hidden');
    loadingIndicator.classList.add('flex');
    connectButton.classList.add('hidden');
    statusElement.classList.add('hidden');
  } else {
    loadingIndicator.classList.add('hidden');
    loadingIndicator.classList.remove('flex');
  }
}

async function updateBalance(): Promise<void> {
  if (!walletBalance) return;
  
  const balance = await freighterService.getAccountBalance();
  if (balance) {
    walletBalance.textContent = `üí∞ ${parseFloat(balance.balance).toFixed(2)} ${balance.asset}`;
  } else {
    walletBalance.textContent = '';
  }
}

async function updateUI(isConnected: boolean, publicKey?: string, network?: string): Promise<void> {
  if (!connectButton || !statusElement) return;

  if (isConnected && publicKey) {
    // Mostrar estado conectado
    connectButton.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r from-emerald-600 to-emerald-700 group-hover:from-emerald-700 group-hover:to-emerald-800 transition-all duration-300"></div><span class="relative inline-flex items-center gap-2">‚úÖ <span>Conectada</span></span>`;
    connectButton.disabled = true;
    connectButton.classList.remove('hidden');
    
    if (walletAddress) {
      const shortAddress = `${publicKey.slice(0, 6)}...${publicKey.slice(-6)}`;
      walletAddress.textContent = shortAddress;
      walletAddress.setAttribute('data-full-address', publicKey);
    }

    if (networkBadge && network) {
      networkBadge.textContent = network;
      networkBadge.className = network === 'TESTNET' 
        ? 'text-xs px-2 py-0.5 rounded-full bg-blue-500/30 text-blue-200 font-medium'
        : 'text-xs px-2 py-0.5 rounded-full bg-yellow-500/30 text-yellow-200 font-medium';
    }

    statusElement.classList.remove('hidden');
    statusElement.classList.add('flex');

    // Actualizar balance
    await updateBalance();
  } else {
    // Mostrar estado desconectado
    connectButton.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-700 group-hover:from-blue-700 group-hover:to-blue-800 transition-all duration-300"></div><div class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-blue-500/20 transition-opacity duration-300"></div><span class="relative inline-flex items-center gap-2">üîó <span>Conectar Wallet</span></span>`;
    connectButton.disabled = false;
    connectButton.classList.remove('hidden');
    statusElement.classList.add('hidden');
    statusElement.classList.remove('flex');

    if (walletBalance) {
      walletBalance.textContent = '';
    }
  }
  
  showLoading(false);
}

async function handleConnect(): Promise<void> {
  console.log('üñ±Ô∏è Click en conectar wallet');
  try {
    showLoading(true);

    // Verificar si Freighter est√° instalado
    const isInstalled = await freighterService.isFreighterInstalled();
    console.log('Status instalaci√≥n:', isInstalled);
    
    if (!isInstalled) {
      showLoading(false);
      const shouldInstall = confirm('Freighter no est√° instalado. ¬øDeseas ir a la p√°gina de instalaci√≥n?');
      if (shouldInstall) {
        window.open('https://www.freighter.app', '_blank');
      }
      return;
    }

    // Intentar conectar
    const result = await freighterService.connect();
    console.log('Resultado de conexi√≥n:', result);
    
    if (!result.success) {
      showLoading(false);
      alert(`‚ùå ${result.message}`);
      await updateUI(false);
      return;
    }

    const networkDetails = freighterService.networkDetails;
    await updateUI(true, result.publicKey, networkDetails?.network);
    
    // Mostrar notificaci√≥n de √©xito
    console.log('‚úÖ Wallet conectada exitosamente');
  } catch (error) {
    showLoading(false);
    console.error('Error al conectar:', error);
    alert('‚ùå Error inesperado al conectar con Freighter');
    await updateUI(false);
  }
}

async function handleDisconnect(): Promise<void> {
  if (!confirm('¬øDeseas desconectar tu wallet?')) return;
  
  try {
    await freighterService.disconnect();
    await updateUI(false);
    console.log('‚úÖ Wallet desconectada');
  } catch (error) {
    console.error('Error al desconectar:', error);
  }
}

function copyAddressToClipboard(): void {
  if (!walletAddress) return;
  
  const fullAddress = walletAddress.getAttribute('data-full-address');
  if (fullAddress) {
    navigator.clipboard.writeText(fullAddress).then(() => {
      const originalText = walletAddress.textContent;
      walletAddress.textContent = '‚úì Copiado!';
      setTimeout(() => {
        if (walletAddress && originalText) {
          walletAddress.textContent = originalText;
        }
      }, 1500);
    }).catch(err => {
      console.error('Error al copiar:', err);
    });
  }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üîÑ Verificando conexi√≥n existente...');
  
  const isConnected = await freighterService.checkConnection();
  if (isConnected && freighterService.publicKey) {
    const networkDetails = freighterService.networkDetails;
    await updateUI(true, freighterService.publicKey, networkDetails?.network);
    console.log('‚úÖ Reconectado autom√°ticamente');
  }
});

if (connectButton) {
    connectButton.addEventListener('click', handleConnect);
    console.log('‚úÖ Event listener agregado al bot√≥n de conectar');
}

disconnectButton?.addEventListener('click', handleDisconnect);
walletAddress?.addEventListener('click', copyAddressToClipboard);

// Escuchar cambios en la wallet
window.addEventListener('walletConnected', (async (event: CustomEvent) => {
  const { publicKey, network } = event.detail as { publicKey: string; network: string };
  await updateUI(true, publicKey, network);
}) as EventListener);

window.addEventListener('walletDisconnected', (async () => {
  await updateUI(false);
}) as EventListener);
</script>