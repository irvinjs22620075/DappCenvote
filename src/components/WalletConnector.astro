---
---
// El servicio se importarÃ¡ en el lado del cliente
---

<div class="flex items-center space-x-4" id="walletConnector">
  <button 
    id="connectWalletBtn"
    class="relative px-6 py-2.5 rounded-lg font-semibold text-white transition-all duration-300 overflow-hidden group"
  >
    <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-700 group-hover:from-blue-700 group-hover:to-blue-800 transition-all duration-300"></div>
    <div class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-blue-500/20 transition-opacity duration-300"></div>
    <span class="relative inline-flex items-center gap-2">
      ðŸ”— <span>Conectar Wallet</span>
    </span>
  </button>
  <div id="walletStatus" class="hidden items-center gap-2 px-4 py-2.5 rounded-lg bg-emerald-500/20 border border-emerald-500/50 group">
    <span class="relative inline-flex h-3 w-3">
      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
      <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
    </span>
    <p id="walletAddress" class="text-sm font-semibold text-emerald-300"></p>
  </div>
</div>

<script>
import { freighterService } from '../services/FreighterService';

const walletConnector = document.getElementById('walletConnector');
const connectButton = document.getElementById('connectWalletBtn');
const statusElement = document.getElementById('walletStatus');

async function updateUI(isConnected: boolean, publicKey?: string) {
  if (!connectButton || !statusElement) return;

  if (isConnected && publicKey) {
    const walletAddress = document.getElementById('walletAddress');
    connectButton.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r from-emerald-600 to-emerald-700 group-hover:from-emerald-700 group-hover:to-emerald-800 transition-all duration-300"></div><span class="relative inline-flex items-center gap-2">âœ… <span>Conectada</span></span>`;
    connectButton.disabled = true;
    
    if (walletAddress) {
      walletAddress.textContent = `${publicKey.slice(0, 6)}...${publicKey.slice(-6)}`;
    }
    statusElement.classList.remove('hidden');
    statusElement.classList.add('flex');
  } else {
    connectButton.innerHTML = `<div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-700 group-hover:from-blue-700 group-hover:to-blue-800 transition-all duration-300"></div><div class="absolute inset-0 opacity-0 group-hover:opacity-100 bg-blue-500/20 transition-opacity duration-300"></div><span class="relative inline-flex items-center gap-2">ðŸ”— <span>Conectar Wallet</span></span>`;
    connectButton.disabled = false;
    statusElement.classList.add('hidden');
    statusElement.classList.remove('flex');
  }
}

async function handleConnect() {
  try {
    // Verificar si Freighter estÃ¡ instalado
    if (!(window as any).freighter) {
      alert('Por favor instala Freighter Wallet');
      window.open('https://www.freighter.app', '_blank');
      return;
    }

    // Verificar si la API estÃ¡ disponible
    if (!(window as any).freighterApi) {
      alert('No se puede acceder a la API de Freighter. Por favor recarga la pÃ¡gina.');
      return;
    }

    // Intentar conectar
    const result = await freighterService.connect();
    console.log('Resultado de conexiÃ³n:', result);
    
    if (!result.success) {
      alert(result.message);
      return;
    }

    updateUI(true, freighterService.publicKey);
  } catch (error) {
    console.error('Error al conectar:', error);
    alert('Error al intentar conectar con Freighter');
  }
}

// Event Listeners
document.addEventListener('DOMContentLoaded', async () => {
  const isAvailable = await freighterService.checkConnection();
  if (isAvailable && freighterService.isConnected) {
    updateUI(true, freighterService.publicKey);
  }
});

connectButton?.addEventListener('click', handleConnect);

// Escuchar cambios en la wallet
window.addEventListener('walletConnected', ((event: CustomEvent) => {
  const { publicKey } = event.detail;
  updateUI(true, publicKey);
}) as EventListener);
</script>