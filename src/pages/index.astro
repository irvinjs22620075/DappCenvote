---
import Layout from '../layouts/Layout.astro';
---

<Layout title="CenVote - Sistema de Votación Descentralizada">
  <div class="min-h-screen bg-gray-100">
    <!-- Header/Navigation -->
    <nav class="bg-white shadow-lg">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex">
            <div class="flex-shrink-0 flex items-center">
              <h1 class="text-2xl font-bold text-primary">CenVote</h1>
            </div>
            <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
              <a href="/users" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Usuarios
              </a>
              <a href="/candidates" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Candidatos
              </a>
              <a href="/surveys" class="inline-flex items-center px-1 pt-1 text-gray-900 hover:text-primary">
                Encuestas
              </a>
            </div>
          </div>
          <div class="flex items-center">
            <button id="connectWalletBtn"
              class="bg-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
              Conectar Wallet
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto py-12 px-4 sm:px-6 lg:px-8">
      <div class="text-center">
        <h2 class="text-4xl font-extrabold text-gray-900 mb-4">
          Bienvenido a CenVote
        </h2>
        <p class="mt-3 max-w-2xl mx-auto text-xl text-gray-500 sm:mt-4">
          Sistema de votación descentralizado seguro y transparente
        </p>
        <div class="mt-10 grid gap-6 md:grid-cols-3">
          <a href="/users"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gestión de Usuarios</h3>
            <p class="text-gray-600">Registra y administra usuarios en el sistema</p>
          </a>
          <a href="/candidates"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gestión de Candidatos</h3>
            <p class="text-gray-600">Administra los candidatos para las votaciones</p>
          </a>
          <a href="/surveys"
            class="p-6 bg-white rounded-lg shadow-lg hover:shadow-xl transition duration-300">
            <h3 class="text-xl font-semibold text-gray-900 mb-2">Gestión de Encuestas</h3>
            <p class="text-gray-600">Crea y administra encuestas de votación</p>
          </a>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  let publicKey = null;

  async function connectWallet() {
    try {
      const freighter = window.freighterApi;
      if (!freighter) {
        alert("Por favor instala Freighter Wallet");
        window.open("https://www.freighter.app", "_blank");
        return;
      }

      // Verificar red
      const network = await freighter.getNetwork();
      if (network !== "TESTNET") {
        alert("Por favor cambia a la red TESTNET en Freighter");
        return;
      }

      await freighter.connect();
      publicKey = await freighter.getPublicKey();
      document.getElementById('connectWalletBtn').textContent = 'Wallet Conectada';
      document.getElementById('connectWalletBtn').classList.add('bg-green-500');
      document.getElementById('connectWalletBtn').classList.remove('bg-primary');

    } catch (error) {
      console.error("Error al conectar wallet:", error);
      alert("Error al conectar con Freighter");
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('connectWalletBtn').addEventListener('click', connectWallet);
  });
</script>
</Layout>
<body>
  <div class="container">
    <center><h1>CenVote</h1></center>
    <center><h2 style="padding:15px;">Sistema de Votación Descentralizada</h2></center>
    <center>
      <button class="btn btn-primary" type="button" onclick="conectarWallet()" style="padding: 10px; width: 150px; height: 50px; border-radius: 30px;">
        Conectar Wallet
      </button>
      <p id="walletStatus"></p>
    </center>
  </div>

  <!-- Formulario para registrar usuario -->
  <div class="container">
    <form id="addUserForm">
      <center><h2 style="border-radius: 25px;">Registrar Usuario</h2></center>
      <input name="user_id" placeholder="ID de usuario" required />
      <input name="first_name" placeholder="Nombre" required />
      <input name="paternal_last_name" placeholder="Apellido paterno" required />
      <input name="maternal_last_name" placeholder="Apellido materno" required />
      <input name="phone" placeholder="Teléfono" required />
      <input name="email" placeholder="Correo electrónico" required />
      <button type="submit">Registrar Usuario</button>
    </form>
  </div>
  <!-- Formulario para registrar candidato -->
	<div class="container">
    <form id="addCandidateForm">
      <center><h2>Registrar Candidato</h2></center>
      <input name="candidate_id" placeholder="ID del candidato" required />
      <input name="user_id" placeholder="ID del usuario existente" required />
      <input name="rfc" placeholder="RFC" required />
      <button type="submit">Registrar Candidato</button>
    </form>
	</div>

    <!-- Formulario para emitir un voto -->
	<div class="container">
    <form id="voteForm">
      <center><h2>Votar por Candidato</h2></center>
      <input name="id_voto" placeholder="ID del voto" required />
      <input name="id_usuario" placeholder="ID del usuario" required />
      <input name="id_candidato" placeholder="ID del candidato" required />
      <input name="fecha_voto" type="date" required />
      <button type="submit">Votar</button>
    </form>
	</div>

    <!-- Formulario para crear encuesta -->
	<div class="container">
    <form id="createSurveyForm">
      <center><h2>Crear Encuesta</h2></center>
      <input name="id_encuesta" placeholder="ID de encuesta" required />
      <input name="nombre_encuesta" placeholder="Nombre de encuesta" required />
      <input name="descripcion" placeholder="Descripción" required />
      <input name="fecha_creacion" type="date" required />
      <input name="fecha_culminacion" type="date" required />
      <input name="id_voto" placeholder="ID de voto" required />
      <input name="id_candidato" placeholder="ID del candidato" required />
      <button type="submit">Crear Encuesta</button>
    </form>
	</div>

    <!-- Formulario para autenticación -->
	<div class="container">
    <form id="authForm">
      <center><h2>Autenticación</h2></center>
      <input name="id" placeholder="ID" required />
      <input name="rfc" placeholder="RFC" required />
      <button type="submit">Autenticar</button>
    </form>
	</div>

  <script type="module">
  const CONTRACT_ID = "GC627W5PYYE5SXWAKC4LB72OYY3JMCP33N7KZ6EILCWAQNHIQDMB3O5W";
  let publicKey = null;

  async function conectarWallet() {
    try {
      const freighter = window.freighterApi || window.freighter || (window.self !== window.top && window.parent.freighter);

      if (!freighter) {
        throw new Error("Freighter no está instalado o no está disponible en esta página.");
      }

      // Obtener clave pública: esto abrirá el prompt de conexión
      publicKey = await freighter.getPublicKey();

      const network = await freighter.getNetwork();

      // Forzar uso de TESTNET si no está en esa red
      if (network !== "TESTNET") {
        alert("Estás en la red equivocada. Por favor, cambia a TESTNET desde Freighter.");
        return;
      }

      document.getElementById('walletStatus').innerText = `Wallet conectada: ${publicKey}`;
      document.getElementById('walletStatus').style.color = "green";
      alert(` Wallet conectada: ${publicKey}\nRed: ${network}`);
    } catch (error) {
      console.error("Error al conectar con Freighter:", error);
      document.getElementById('walletStatus').innerText = " Error al conectar wallet";
      document.getElementById('walletStatus').style.color = "red";

      if (error.message.includes("Freighter")) {
        window.open("https://www.freighter.app", "_blank");
      }
    }
  }

  async function invokeContractFunction(method, args = []) {
    if (!publicKey) {
      const shouldConnect = confirm("Debes conectar tu wallet primero. ¿Conectar ahora?");
      if (shouldConnect) {
        await conectarWallet();
      } else {
        return;
      }
    }

    try {
      const freighter = window.freighterApi || window.freighter;

      const transactionXDR = await freighter.getTransaction({
        network: "TESTNET",
        source: publicKey,
        contractId: CONTRACT_ID,
        method,
        args
      });

      const txResponse = await freighter.signAndSubmitTransaction(transactionXDR);

      alert(` Transacción enviada\nHash: ${txResponse.hash}`);
      console.log("Transacción completada:", txResponse);
      return txResponse;
    } catch (err) {
      console.error("Error en invokeContractFunction:", err);
      alert(` Error en la transacción:\n${err.message}`);
      throw err;
    }
  }

  document.getElementById('addUserForm').addEventListener('submit', async e => {
    e.preventDefault();
    try {
      const formData = new FormData(e.target);
      const args = {
        user_id: formData.get('user_id'),
        first_name: formData.get('first_name'),
        paternal_last_name: formData.get('paternal_last_name'),
        maternal_last_name: formData.get('maternal_last_name'),
        phone: formData.get('phone'),
        email: formData.get('email')
      };
      await invokeContractFunction('registrar_usuario', args);
    } catch (error) {
      console.error("Error en formulario:", error);
    }
  });

  window.conectarWallet = conectarWallet;
  window.invokeContractFunction = invokeContractFunction;
</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</body>